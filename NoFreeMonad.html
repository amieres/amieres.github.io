<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <!--
      The No Free Monad for old men parameters will be replaced with the
      document title extracted from the <h1> element or
      file name, if there is no <h1> heading
    -->
    <title>No Free Monad for old men</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="styles/style.css" />
    <script src="styles/tips.js" type="text/javascript"></script>
    
    <script language="javascript" type="text/javascript">
      function init()
      {
        try {
          websocket = new WebSocket("ws://" + window.location.hostname + ":" + window.location.port + "/websocket");
          websocket.onmessage = function(evt) { location.reload(); };
        } catch (e) { /* silently ignore lack of websockets */ }
      }
      window.addEventListener("load", init, false);
    </script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fslab.org">fslab.org</a></li>
          <li><a href="http://fsharp.github.io/FSharp.Data/">F# Data</a></li>
          <li><a href="http://bluemountaincapital.github.io/Deedle">Deedle</a></li>
          <li><a href="http://bluemountaincapital.github.io/FSharpRProvider">R Provider</a></li>
          <li><a href="http://tahahachana.github.io/XPlot/">XPlot</a></li>
          <li><a href="http://www.mathdotnet.com/">Math.Net</a></li>
        </ul>
        <h3 class="muted">Journal</h3>
      </div>
      <hr />
      <div class="row" style="margin-top:30px">
        <div class="span1"></div>
        <div class="span10" id="main">
          <h1>No Free Monad for old men</h1>
<h3><strong> <em>Update!</em> </strong></h3>
<p>Clarifications from Seemann et al. showed me
that Free Monads are used not just for keeping code pure but also as the equivalent of an interface in OOP.
For that reason I added a mechanism for dependency injection.</p>
<h3>What is better than Free Monad? Async Monad!</h3>
<p>I have been reading with great interest a series of posts by Mark Seemann
about dependency injection (and 'rejection') using F#.
His very pedagogical style together with the fact that he, like
me, has gone from OOP to FP made it especially relevant and eye-opening for me.
In those posts, he uses the Free Monad as a functional alternative for dependency injection.
They are a must read:</p>
<ul>
<li><a href="http://blog.ploeh.dk/2017/01/27/from-dependency-injection-to-dependency-rejection/">From dependency injection to dependency rejection</a></li>
<li><a href="http://blog.ploeh.dk/2017/07/10/pure-interactions/">Pure interactions</a></li>
</ul>
<p>Seemann's posts work with very didactic examples of a restaurant reservation study case. I wanted to write my own take on the same study case basically
copying his code and rewriting it in my own style and doing some variations to help me understand it better.</p>
<p>I myself had analyzed the Free Monad before in another <a href="/FreeMonad.html">post</a>. That post, very much like this one,
was intended mainly for my own consumption. In it, I concluded that two types: the DSL Functor and the Free Monad
could be fused into one, thus reducing boilerplate. I wanted to try the same approach with Seamann's
case study where he combines two Free Monads (by stacking them and/or adding them as suggested by a commenter)
to see if my conclusion still held true.</p>
<h3>A funny thing happened.</h3>
<p>I could not finish. As is logical, my mock HTTP Client functions return <code>Async&lt;&gt;</code> and
so I wrote my interpreter with type <code>ReservationsApi&lt;'a&gt; -&gt; Async&lt;'a&gt;</code>.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// interpreterReservationsApi: ReservationsApi&lt;&#39;a&gt; -&gt; Async&lt;&#39;a&gt;</span>
<span class="k">let</span> <span class="k">rec</span> <span class="i">interpreterReservationsApi</span> <span class="i">resApi</span> <span class="o">=</span> 
    <span class="k">match</span> <span class="i">resApi</span> <span class="k">with</span>
    | <span class="i">ReturnRA</span>         <span class="i">x</span>         <span class="k">-&gt;</span> <span class="i">async</span> { <span class="k">return</span> <span class="i">x</span> }
    | <span class="i">GetSlots</span>        (<span class="i">d</span>, <span class="i">fNext</span>) <span class="k">-&gt;</span> <span class="i">async</span> { <span class="k">let!</span>     <span class="i">slots</span> <span class="o">=</span> <span class="i">getSlotsHttp</span> <span class="i">d</span> 
                                            <span class="k">return!</span>  <span class="i">fNext</span> <span class="i">slots</span> <span class="o">|&gt;</span> <span class="i">interpreterReservationsApi</span> }
    | <span class="i">PostReservation</span> (<span class="i">r</span>,  <span class="i">next</span>) <span class="k">-&gt;</span> <span class="i">async</span> { <span class="k">do!</span>       <span class="i">postReservationHttp</span> <span class="i">r</span>
                                            <span class="k">return!</span>   <span class="i">next</span>       <span class="o">|&gt;</span> <span class="i">interpreterReservationsApi</span> }
</code></pre></td>
</tr>
</table>
<p>The interpreter was going from a Monad to another Monad. Hmmm!
That led me to the realization that the interpreter written that way was a pure function because
all the functions it was calling were also pure. Those functions return <code>Async&lt;&gt;</code> values, which makes them pure too.
That made me question the whole exercise. In order to make the code pure, all I needed to do
was wrap the impure functions with <code>Async&lt;&gt;</code>. What could be easier?</p>
<p>No DSL, no Free Monad, no builder types, no interpreters were needed. <code>Async.RunSynchronously</code> was the interpreter.</p>
<p>So I rewrote the exercise using Asyncs instead:</p>
<h2>1.- <a href="http://blog.ploeh.dk/2017/07/17/a-pure-command-line-wizard/">Command-line wizard</a>:</h2>
<p>Taken from <a href="http://blog.ploeh.dk/2017/07/17/a-pure-command-line-wizard/">here</a>.</p>
<p>The console api functions are defined in a module with a dummy definition, but they are mutable:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">module</span> <span class="i">CliInjection</span> <span class="o">=</span>
    <span class="k">let</span> <span class="k">mutable</span> <span class="k">private</span>       <span class="i">readLine</span>  <span class="o">:</span> <span class="i">unit</span>   <span class="k">-&gt;</span> <span class="i">string</span> <span class="o">=</span> <span class="k">fun</span> () <span class="k">-&gt;</span> <span class="s">&quot;&quot;</span>
    <span class="k">let</span> <span class="k">mutable</span> <span class="k">private</span>       <span class="i">writeLine</span> <span class="o">:</span> <span class="i">string</span> <span class="k">-&gt;</span> <span class="i">unit</span>   <span class="o">=</span> <span class="i">ignore</span>
    <span class="k">let</span> <span class="i">inject</span>(<span class="i">read</span>, <span class="i">write</span>) <span class="o">=</span> <span class="i">readLine</span>  <span class="o">&lt;-</span> <span class="i">read</span>
                              <span class="i">writeLine</span> <span class="o">&lt;-</span> <span class="i">write</span>

    <span class="k">let</span> <span class="i">WriteLine</span> <span class="i">s</span>         <span class="o">=</span> <span class="i">async</span> {        <span class="i">writeLine</span> <span class="i">s</span>  }
    <span class="k">let</span> <span class="i">ReadLine</span>            <span class="o">=</span> <span class="i">async</span> { <span class="k">return</span> <span class="i">readLine</span>  () }
</code></pre></td>
</tr>
</table>
<p>The <code>inject</code> function provides the mechanism for injecting the implementation.
The public functions <code>WriteLine</code> <code>ReadLine</code> use the <code>Async&lt;&gt;</code> monad to make them pure.</p>
<p>Some derived Console API functions</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span class="i">promptFor</span> <span class="i">test</span> <span class="i">prompt</span> <span class="i">reject</span> <span class="o">=</span> <span class="i">async</span> {
    <span class="k">do!</span>         <span class="i">CliInjection</span><span class="o">.</span><span class="i">WriteLine</span> <span class="i">prompt</span>
    <span class="k">let!</span>   <span class="i">v</span> <span class="o">=</span>  <span class="i">CliInjection</span><span class="o">.</span><span class="i">ReadLine</span>
    <span class="k">match</span>  <span class="i">v</span> <span class="o">|&gt;</span> <span class="i">test</span> <span class="k">with</span>
    | <span class="i">Some</span> <span class="i">r</span> <span class="k">-&gt;</span> <span class="k">return</span>  <span class="i">r</span>
    | <span class="i">None</span>   <span class="k">-&gt;</span> <span class="k">do!</span>     <span class="i">CliInjection</span><span class="o">.</span><span class="i">WriteLine</span>             <span class="i">reject</span>
                <span class="k">return!</span> <span class="i">promptFor</span> <span class="i">test</span> <span class="i">prompt</span> <span class="i">reject</span>
}

<span class="k">type</span> <span class="i">Net</span><span class="o">.</span><span class="i">Mail</span><span class="o">.</span><span class="i">MailAddress</span> <span class="k">with</span>
    <span class="k">static</span> <span class="k">member</span> <span class="i">TryParse</span> <span class="i">s</span> <span class="o">=</span> <span class="k">try</span> <span class="i">Net</span><span class="o">.</span><span class="i">Mail</span><span class="o">.</span><span class="i">MailAddress</span> <span class="i">s</span> <span class="o">|&gt;</span> <span class="i">Some</span> <span class="k">with</span> <span class="i">e</span> <span class="k">-&gt;</span> <span class="i">None</span>

<span class="k">let</span> <span class="i">promptForString</span> <span class="o">=</span> <span class="i">promptFor</span> (<span class="k">fun</span> (<span class="i">s</span><span class="o">:</span><span class="i">string</span>) <span class="k">-&gt;</span>  <span class="i">s</span><span class="o">.</span><span class="i">Trim</span>()   <span class="o">|&gt;</span> <span class="k">function</span> <span class="s">&quot;&quot;</span>      <span class="k">-&gt;</span> <span class="i">None</span>   | <span class="i">r</span> <span class="k">-&gt;</span> <span class="i">Some</span> <span class="i">r</span>)
<span class="k">let</span> <span class="i">promptForEMail</span>  <span class="o">=</span> <span class="i">promptFor</span> (<span class="i">Net</span><span class="o">.</span><span class="i">Mail</span><span class="o">.</span><span class="i">MailAddress</span><span class="o">.</span><span class="i">TryParse</span>                                            )
<span class="k">let</span> <span class="i">promptForNumber</span> <span class="o">=</span> <span class="i">promptFor</span> (<span class="i">Int32</span>               <span class="o">.</span><span class="i">TryParse</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="k">function</span> <span class="k">true</span>, <span class="i">r</span> <span class="k">-&gt;</span> <span class="i">Some</span> <span class="i">r</span> | _ <span class="k">-&gt;</span> <span class="i">None</span>  )
<span class="k">let</span> <span class="i">promptForDate</span>   <span class="o">=</span> <span class="i">promptFor</span> (<span class="i">DateTime</span>            <span class="o">.</span><span class="i">TryParse</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="k">function</span> <span class="k">true</span>, <span class="i">r</span> <span class="k">-&gt;</span> <span class="i">Some</span> <span class="i">r</span> | _ <span class="k">-&gt;</span> <span class="i">None</span>  )
</code></pre></td>
</tr>
</table>
<p>The reservation record:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span class="i">Reservation</span> <span class="o">=</span> {
    <span class="i">Date</span>     <span class="o">:</span> <span class="i">DateTime</span>
    <span class="i">Name</span>     <span class="o">:</span> <span class="i">string</span>
    <span class="i">Email</span>    <span class="o">:</span> <span class="i">string</span>
    <span class="i">Quantity</span> <span class="o">:</span> <span class="i">int</span> 
}
</code></pre></td>
</tr>
</table>
<p>A wizard to read the reservation:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">readReservationRequest</span> <span class="o">=</span> <span class="i">async</span> {
    <span class="k">let!</span> <span class="i">count</span> <span class="o">=</span> <span class="i">promptForNumber</span> <span class="s">&quot;Please enter number of diners:&quot;</span>   <span class="s">&quot;Not a valid integer.&quot;</span>
    <span class="k">let!</span> <span class="i">date</span>  <span class="o">=</span> <span class="i">promptForDate</span>   <span class="s">&quot;Please enter your desired date:&quot;</span>  <span class="s">&quot;Not a valid date.&quot;</span>
    <span class="k">let!</span> <span class="i">name</span>  <span class="o">=</span> <span class="i">promptForString</span> <span class="s">&quot;Please enter your name:&quot;</span>          <span class="s">&quot;Not a valid name.&quot;</span>
    <span class="k">let!</span> <span class="i">email</span> <span class="o">=</span> <span class="i">promptForEMail</span>  <span class="s">&quot;Please enter your email address:&quot;</span> <span class="s">&quot;Not a valid email.&quot;</span>
    <span class="k">return</span> { <span class="i">Date</span> <span class="o">=</span> <span class="i">date</span>; <span class="i">Name</span> <span class="o">=</span> <span class="i">name</span>; <span class="i">Email</span> <span class="o">=</span> <span class="i">email</span><span class="o">.</span><span class="i">Address</span>; <span class="i">Quantity</span> <span class="o">=</span> <span class="i">count</span> } 
  }
</code></pre></td>
</tr>
</table>
<p>To execute the monad we inject the desired implementation and call Async.RunSynchronously</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">getReservation</span> <span class="i">cli</span> <span class="o">=</span>
    <span class="i">CliInjection</span><span class="o">.</span><span class="i">inject</span> <span class="i">cli</span>
    <span class="i">readReservationRequest</span>
    <span class="o">|&gt;</span> <span class="i">Async</span><span class="o">.</span><span class="i">RunSynchronously</span>
    <span class="o">|&gt;</span> <span class="i">printfn</span> <span class="s">&quot;%A&quot;</span>
</code></pre></td>
</tr>
</table>
<p>Now lets define a MockConsole for testing:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">module</span> <span class="i">MockConsole</span> <span class="o">=</span>
    <span class="k">let</span> <span class="i">readLines</span> (<span class="i">txt</span><span class="o">:</span><span class="i">string</span>) <span class="o">=</span> 
        <span class="k">let</span> <span class="i">current</span> <span class="o">=</span> <span class="i">txt</span><span class="o">.</span><span class="i">Split</span> <span class="s">&#39;\n&#39;</span> <span class="o">|&gt;</span> <span class="i">Array</span><span class="o">.</span><span class="i">map</span> (<span class="k">fun</span> <span class="i">s</span> <span class="k">-&gt;</span> <span class="i">s</span><span class="o">.</span><span class="i">Trim</span>()) <span class="o">|&gt;</span> <span class="i">Array</span><span class="o">.</span><span class="i">filter</span> ((<span class="o">&lt;&gt;</span>)<span class="s">&quot;&quot;</span>) <span class="o">|&gt;</span> <span class="i">ref</span>
        <span class="k">fun</span> () <span class="k">-&gt;</span>
            <span class="k">let</span> <span class="i">head</span> <span class="o">=</span> <span class="i">Array</span><span class="o">.</span><span class="i">head</span> <span class="o">!</span><span class="i">current</span>
            <span class="i">current</span> <span class="o">:=</span> (<span class="o">!</span><span class="i">current</span>)<span class="o">.</span>[<span class="n">1..</span>]
            <span class="i">printfn</span> <span class="s">&quot;%s&quot;</span> <span class="i">head</span>
            <span class="i">head</span>
    <span class="k">let</span> <span class="i">input1</span> <span class="o">=</span> <span class="s">&quot;</span>
<span class="s">        x</span>
<span class="s">        5</span>
<span class="s">        x</span>
<span class="s">        11/11/11</span>
<span class="s">        Abe</span>
<span class="s">        x</span>
<span class="s">        amieres@b.c</span>
<span class="s">    &quot;</span>
    <span class="k">let</span> <span class="i">input2</span> <span class="o">=</span> <span class="s">&quot;</span>
<span class="s">        15</span>
<span class="s">        12/31/1911</span>
<span class="s">        Schroedinger&#39;s cat</span>
<span class="s">        Schroedinger@dead.alive</span>
<span class="s">    &quot;</span>
    <span class="k">let</span> <span class="i">toInject1</span>() <span class="o">=</span> (<span class="i">readLines</span> <span class="i">input1</span>, <span class="i">printfn</span> <span class="s">&quot;%s&quot;</span>   )
    <span class="k">let</span> <span class="i">toInject2</span>() <span class="o">=</span> (<span class="i">readLines</span> <span class="i">input2</span>, <span class="i">printfn</span> <span class="s">&quot;:: %s&quot;</span>)
</code></pre></td>
</tr>
</table>
<p>We run it passing the functions to be injected:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">getReservation</span> <span class="o">&lt;|</span> <span class="i">MockConsole</span><span class="o">.</span><span class="i">toInject1</span>()
</code></pre></td>
</tr>
</table>
<table class="pre"><tr><td><pre><code>Please enter number of diners:
x
Not a valid integer.
Please enter number of diners:
5
Please enter your desired date:
x
Not a valid date.
Please enter your desired date:
11/11/11
Please enter your name:
Abe
Please enter your email address:
x
Not a valid email.
Please enter your email address:
amieres@b.c
{Date = 11/11/2011 12:00:00 AM;
 Name = "Abe";
 Email = "amieres@b.c";
 Quantity = 5;}</code></pre></td></tr></table>
<p>Another run with different functions:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">getReservation</span> <span class="o">&lt;|</span> <span class="i">MockConsole</span><span class="o">.</span><span class="i">toInject2</span>()
</code></pre></td>
</tr>
</table>
<table class="pre"><tr><td><pre><code>:: Please enter number of diners:
15
:: Please enter your desired date:
12/31/1911
:: Please enter your name:
Schroedinger's cat
:: Please enter your email address:
Schroedinger@dead.alive
{Date = 12/31/1911 12:00:00 AM;
 Name = "Schroedinger's cat";
 Email = "Schroedinger@dead.alive";
 Quantity = 15;}</code></pre></td></tr></table>
<p>To call it with the actual Console implementation:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">getReservationConsole</span>() <span class="o">=</span> <span class="i">getReservation</span> <span class="o">&lt;|</span> (<span class="i">Console</span><span class="o">.</span><span class="i">ReadLine</span>, <span class="i">Console</span><span class="o">.</span><span class="i">WriteLine</span>)
</code></pre></td>
</tr>
</table>
<h2>2.- <a href="http://blog.ploeh.dk/2017/07/31/combining-free-monads-in-f/">HTTP API client module</a></h2>
<p>Taken from <a href="http://blog.ploeh.dk/2017/07/31/combining-free-monads-in-f/">here</a>.</p>
<p>The Slot type:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span class="i">Slot</span> <span class="o">=</span> { <span class="i">Date</span> <span class="o">:</span> <span class="i">DateTime</span>; <span class="i">SeatsLeft</span> <span class="o">:</span> <span class="i">int</span> }
</code></pre></td>
</tr>
</table>
<p>Lets define the api injection module this way, following the same recipe as above.
The only difference is that we already expect the functions to return <code>Async&lt;&gt;</code>:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
<span class="l">9: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">module</span> <span class="i">ResApiInjection</span> <span class="o">=</span>
    <span class="k">let</span> <span class="k">mutable</span> <span class="k">private</span>     <span class="i">getSlots</span>       <span class="o">:</span> <span class="i">DateTime</span>    <span class="k">-&gt;</span> <span class="i">Async</span><span class="o">&lt;</span><span class="i">Slot</span> <span class="i">list</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">fun</span> _ <span class="k">-&gt;</span> <span class="i">async</span> { <span class="k">return</span> [] }
    <span class="k">let</span> <span class="k">mutable</span> <span class="k">private</span>     <span class="i">postReservation</span><span class="o">:</span> <span class="i">Reservation</span> <span class="k">-&gt;</span> <span class="i">Async</span><span class="o">&lt;</span><span class="i">unit</span><span class="o">&gt;</span>      <span class="o">=</span> <span class="k">fun</span> _ <span class="k">-&gt;</span> <span class="i">async</span> { ()        }
    <span class="k">let</span> <span class="i">inject</span>(<span class="i">get</span>, <span class="i">post</span>) <span class="o">=</span> <span class="i">getSlots</span>        <span class="o">&lt;-</span> <span class="i">get</span>
                            <span class="i">postReservation</span> <span class="o">&lt;-</span> <span class="i">post</span>
    
    <span class="k">let</span> <span class="i">GetSlots</span>        <span class="i">date</span> <span class="o">=</span> <span class="i">getSlots</span>        <span class="i">date</span>
    <span class="k">let</span> <span class="i">PostReservation</span> <span class="i">res</span>  <span class="o">=</span> <span class="i">postReservation</span> <span class="i">res</span> 
    
</code></pre></td>
</tr>
</table>
<p>A reservation wizard that queries the HTTP server and makes the reservation.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">tryReserve</span>          <span class="o">=</span> <span class="i">async</span> {
    <span class="k">let!</span> <span class="i">count</span>          <span class="o">=</span> <span class="i">promptForNumber</span> <span class="s">&quot;Please enter number of diners:&quot;</span>   <span class="s">&quot;Not a valid integer.&quot;</span>
    <span class="k">let!</span> <span class="i">date</span>           <span class="o">=</span> <span class="i">promptForDate</span>   <span class="s">&quot;Please enter your desired date:&quot;</span>  <span class="s">&quot;Not a valid date.&quot;</span>
    <span class="k">let!</span> <span class="i">slots</span>          <span class="o">=</span> <span class="i">ResApiInjection</span><span class="o">.</span><span class="i">GetSlots</span> <span class="i">date</span>
    <span class="k">let</span>  <span class="i">availableSeats</span> <span class="o">=</span> <span class="i">slots</span> <span class="o">|&gt;</span> <span class="i">List</span><span class="o">.</span><span class="i">sumBy</span> (<span class="k">fun</span> <span class="i">slot</span> <span class="k">-&gt;</span> <span class="i">slot</span><span class="o">.</span><span class="i">SeatsLeft</span>)
    <span class="k">if</span> <span class="i">availableSeats</span>   <span class="o">&lt;</span> <span class="i">count</span>
    <span class="k">then</span> <span class="k">do!</span> <span class="i">sprintf</span> <span class="s">&quot;****************    </span>
<span class="s">Only %i remaining seats.</span>
<span class="s">****************&quot;</span> <span class="i">availableSeats</span>  <span class="o">|&gt;</span> <span class="i">CliInjection</span><span class="o">.</span><span class="i">WriteLine</span>
    <span class="k">else</span> <span class="k">let!</span> <span class="i">name</span>      <span class="o">=</span> <span class="i">promptForString</span> <span class="s">&quot;Please enter your name:&quot;</span>          <span class="s">&quot;Not a valid name.&quot;</span>
         <span class="k">let!</span> <span class="i">email</span>     <span class="o">=</span> <span class="i">promptForEMail</span>  <span class="s">&quot;Please enter your email address:&quot;</span> <span class="s">&quot;Not a valid email.&quot;</span>
         <span class="k">do!</span> { <span class="i">Date</span>     <span class="o">=</span> <span class="i">date</span>; <span class="i">Name</span> <span class="o">=</span> <span class="i">name</span>; <span class="i">Email</span> <span class="o">=</span> <span class="i">email</span><span class="o">.</span><span class="i">Address</span>; <span class="i">Quantity</span> <span class="o">=</span> <span class="i">count</span> } <span class="o">|&gt;</span> <span class="i">ResApiInjection</span><span class="o">.</span><span class="i">PostReservation</span>
         <span class="k">do!</span> <span class="i">sprintf</span> <span class="s">&quot;****************</span>
<span class="s">%s party of %d, reserved for %A.</span>
<span class="s">****************&quot;</span> <span class="i">name</span> <span class="i">count</span> <span class="i">date</span> <span class="o">|&gt;</span> <span class="i">CliInjection</span><span class="o">.</span><span class="i">WriteLine</span>
    }
</code></pre></td>
</tr>
</table>
<p>To run it we pass both the Console api and the reservations api:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">reserve</span> <span class="i">cli</span> <span class="i">resApi</span> <span class="o">=</span> 
    <span class="i">CliInjection</span>   <span class="o">.</span><span class="i">inject</span> <span class="i">cli</span>
    <span class="i">ResApiInjection</span><span class="o">.</span><span class="i">inject</span> <span class="i">resApi</span>
    <span class="i">tryReserve</span> 
    <span class="o">|&gt;</span> <span class="i">Async</span><span class="o">.</span><span class="i">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<p>Here is an implementation for the Reservations api that returns a random number of available seats:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">module</span> <span class="i">RandomResApi</span> <span class="o">=</span>
    <span class="k">let</span> <span class="i">random</span> <span class="o">=</span> <span class="k">lazy</span> (<span class="i">System</span><span class="o">.</span><span class="i">Random</span> <span class="i">DateTime</span><span class="o">.</span><span class="i">Now</span><span class="o">.</span><span class="i">Millisecond</span>)
    
    <span class="k">let</span> <span class="i">getSlotsHttp</span>         <span class="i">date</span>             <span class="o">=</span> <span class="i">async</span> { 
        <span class="k">do!</span> <span class="i">Async</span><span class="o">.</span><span class="i">Sleep</span> <span class="n">1000</span>
        <span class="k">return</span> [ { <span class="i">Date</span> <span class="o">=</span> <span class="i">date</span> ; <span class="i">SeatsLeft</span> <span class="o">=</span> <span class="i">random</span><span class="o">.</span><span class="i">Force</span>()<span class="o">.</span><span class="i">Next</span>(<span class="n">20</span>) } ] 
      }
    <span class="k">let</span> <span class="i">postReservationHttp</span> (<span class="i">res</span><span class="o">:</span><span class="i">Reservation</span>) <span class="o">=</span> <span class="i">async</span> { 
        <span class="k">do!</span> <span class="i">Async</span><span class="o">.</span><span class="i">Sleep</span> <span class="n">1500</span>
      }
    <span class="k">let</span> <span class="i">toInject</span>() <span class="o">=</span> (<span class="i">getSlotsHttp</span>, <span class="i">postReservationHttp</span>)
</code></pre></td>
</tr>
</table>
<p>We call <code>reserve</code> passing both apis</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">reserve</span> <span class="o">&lt;|</span> <span class="i">MockConsole</span><span class="o">.</span><span class="i">toInject2</span>() <span class="o">&lt;|</span> <span class="i">RandomResApi</span><span class="o">.</span><span class="i">toInject</span>()
</code></pre></td>
</tr>
</table>
<table class="pre"><tr><td><pre><code>:: Please enter number of diners:
15
:: Please enter your desired date:
12/31/1911
:: ****************    
Only 0 remaining seats.
****************</code></pre></td></tr></table>
<p>As its name indicates the output is random.</p>
<p>For testing we can have another version with a fixed number of available seats:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">module</span> <span class="i">MockReservationAPI</span> <span class="o">=</span>
    <span class="k">let</span> <span class="k">mutable</span> <span class="i">available</span> <span class="o">=</span> <span class="n">18</span>

    <span class="k">let</span> <span class="i">getSlotsHttp</span>         <span class="i">date</span>             <span class="o">=</span> <span class="i">async</span> { 
        <span class="k">do!</span> <span class="i">Async</span><span class="o">.</span><span class="i">Sleep</span> <span class="n">1000</span>
        <span class="k">return</span> [ { <span class="i">Date</span> <span class="o">=</span> <span class="i">date</span> ; <span class="i">SeatsLeft</span> <span class="o">=</span> <span class="i">available</span> } ] 
      }
    <span class="k">let</span> <span class="i">postReservationHttp</span> (<span class="i">res</span><span class="o">:</span><span class="i">Reservation</span>) <span class="o">=</span> <span class="i">async</span> { 
        <span class="k">do!</span> <span class="i">Async</span><span class="o">.</span><span class="i">Sleep</span> <span class="n">1500</span>
        <span class="i">available</span> <span class="o">&lt;-</span> <span class="i">available</span> <span class="o">-</span> <span class="i">res</span><span class="o">.</span><span class="i">Quantity</span> 
      }
    <span class="k">let</span> <span class="i">toInject</span>() <span class="o">=</span> (<span class="i">getSlotsHttp</span>, <span class="i">postReservationHttp</span>)
</code></pre></td>
</tr>
</table>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">reserve</span> <span class="o">&lt;|</span> <span class="i">MockConsole</span><span class="o">.</span><span class="i">toInject2</span>() <span class="o">&lt;|</span> <span class="i">MockReservationAPI</span><span class="o">.</span><span class="i">toInject</span>()
</code></pre></td>
</tr>
</table>
<table class="pre"><tr><td><pre><code>:: Please enter number of diners:
15
:: Please enter your desired date:
12/31/1911
:: Please enter your name:
Schroedinger's cat
:: Please enter your email address:
Schroedinger@dead.alive
:: ****************
Schroedinger's cat party of 15, reserved for 12/31/1911 12:00:00 AM.
****************</code></pre></td></tr></table>
<p>Since originally there were 18 seats, reservation for 5 more will fail.
Notice the difference in the WriteLine
output between the 2 outputs:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">reserve</span> <span class="o">&lt;|</span> <span class="i">MockConsole</span><span class="o">.</span><span class="i">toInject1</span>() <span class="o">&lt;|</span> <span class="i">MockReservationAPI</span><span class="o">.</span><span class="i">toInject</span>()
</code></pre></td>
</tr>
</table>
<table class="pre"><tr><td><pre><code>Please enter number of diners:
x
Not a valid integer.
Please enter number of diners:
5
Please enter your desired date:
x
Not a valid date.
Please enter your desired date:
11/11/11
****************    
Only 3 remaining seats.
****************</code></pre></td></tr></table>
<p>Using async we accomplish the same objective and avoid a lot of boilerplate.
True, this does not follow the DSL-interpreter pattern typical of the Free Monad
and there may be other uses that are possible with the Free Monad,
but this solution allows dependency injection
separation of pure and impure code, separation of concerns and composition,
all in a very clean and powerful way.</p>
<p>Using the <code>async</code> Computational Expression has the added advantage of
already having strong implementations for <code>try-finally</code>, <code>try-with</code>, <code>use</code>, <code>while</code>, <code>for</code> and other
features that are not easy to implement.</p>


          
        </div>
        <div class="span1"></div>
      </div>
      <hr style="margin-top:50px;"/>
      <footer class="footer" style="text-align:center">
          <div id="disqus_thread"></div>
          <script>
              var disqus_config = function () {
                  //this.page.url = "http://No Free Monad for old men.html";  // Replace PAGE_URL with your page's canonical URL variable
                  this.page.identifier = "No Free Monad for old men"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
              };
              (function () { // DON'T EDIT BELOW THIS LINE
                  var d = document, s = d.createElement('script');
                  s.src = 'https://amieresgithub.disqus.com/embed.js';
                  s.setAttribute('data-timestamp', +new Date());
                  (d.head || d.body).appendChild(s);
              })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </footer>
    </div>
  </body>
</html>
