<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <!--
      The No Free Monad for old men parameters will be replaced with the
      document title extracted from the <h1> element or
      file name, if there is no <h1> heading
    -->
    <title>No Free Monad for old men</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="styles/style.css" />
    <script src="styles/tips.js" type="text/javascript"></script>
    
    <script language="javascript" type="text/javascript">
      function init()
      {
        try {
          websocket = new WebSocket("ws://" + window.location.hostname + ":" + window.location.port + "/websocket");
          websocket.onmessage = function(evt) { location.reload(); };
        } catch (e) { /* silently ignore lack of websockets */ }
      }
      window.addEventListener("load", init, false);
    </script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fslab.org">fslab.org</a></li>
          <li><a href="http://fsharp.github.io/FSharp.Data/">F# Data</a></li>
          <li><a href="http://bluemountaincapital.github.io/Deedle">Deedle</a></li>
          <li><a href="http://bluemountaincapital.github.io/FSharpRProvider">R Provider</a></li>
          <li><a href="http://tahahachana.github.io/XPlot/">XPlot</a></li>
          <li><a href="http://www.mathdotnet.com/">Math.Net</a></li>
        </ul>
        <h3 class="muted">Journal</h3>
      </div>
      <hr />
      <div class="row" style="margin-top:30px">
        <div class="span1"></div>
        <div class="span10" id="main">
          <h1>No Free Monad for old men</h1>
<h3>What is better than Free Monad? Async Monad!</h3>
<p>I have been reading with great interest a series of posts by Mark Seemann
about dependency injection (and 'rejection') using F#.
His very pedagogical style together with the fact that he, like
me, have gone from OOP to FP made it specially relevant and eye opening for me.
In those posts he uses the Free Monad as a functional alternative for dependency injection.
You must read them:</p>
<ul>
<li><a href="http://blog.ploeh.dk/2017/01/27/from-dependency-injection-to-dependency-rejection/">From dependency injection to dependency rejection</a></li>
<li><a href="http://blog.ploeh.dk/2017/07/10/pure-interactions/">Pure interactions</a></li>
</ul>
<p>Seemann's posts work with very didactic examples of a restaurant reservation study case. I wanted to write my own take on the same study case basically
copying his code and rewriting it in my own style and doing some variations to help me understand it better.</p>
<p>I myself had analyzed the Free Monad before in another <a href="https://amieres.github.io/FreeMonad.html">post</a>. That post, very much like this one,
was intended mainly for my own consumption. In it, I concluded that two types: the DSL Functor and the Free Monad
could be fused into one, thus reducing boiler plate. I wanted to try the same approach with Seamann's
case study where he combines two Free Monads (by stacking them and/or adding them as suggested by a commenter)
to see if my conclusion still held true.</p>
<h3>A funny thing happened.</h3>
<p>I could not finish. As is logical, my mock HTTP Client functions return <code>Async&lt;&gt;</code> and
so I wrote my interpreter with type <code>ReservationsApi&lt;'a&gt; -&gt; Async&lt;'a&gt;</code>.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// interpreterReservationsApi: ReservationsApi&lt;&#39;a&gt; -&gt; Async&lt;&#39;a&gt;</span>
<span class="k">let</span> <span class="k">rec</span> <span class="i">interpreterReservationsApi</span> <span class="i">resApi</span> <span class="o">=</span> 
    <span class="k">match</span> <span class="i">resApi</span> <span class="k">with</span>
    | <span class="i">ReturnRA</span>         <span class="i">x</span>         <span class="k">-&gt;</span> <span class="i">async</span> { <span class="k">return</span> <span class="i">x</span> }
    | <span class="i">GetSlots</span>        (<span class="i">d</span>, <span class="i">fNext</span>) <span class="k">-&gt;</span> <span class="i">async</span> { <span class="k">let!</span>     <span class="i">slots</span> <span class="o">=</span> <span class="i">getSlotsHttp</span> <span class="i">d</span> 
                                            <span class="k">return!</span>  <span class="i">fNext</span> <span class="i">slots</span> <span class="o">|&gt;</span> <span class="i">interpreterReservationsApi</span> }
    | <span class="i">PostReservation</span> (<span class="i">r</span>,  <span class="i">next</span>) <span class="k">-&gt;</span> <span class="i">async</span> { <span class="k">do!</span>       <span class="i">postReservationHttp</span> <span class="i">r</span>
                                            <span class="k">return!</span>   <span class="i">next</span>       <span class="o">|&gt;</span> <span class="i">interpreterReservationsApi</span> }
</code></pre></td>
</tr>
</table>
<p>The interpreter was going from a Monad to another Monad. Hmmm!
That led me to the realization that the interpreter written that way was a pure function because
all the functions it was calling were also pure. Those functions return <code>Async&lt;&gt;</code> values, which makes them pure too.
That made me question the whole exercise. In order to make the code pure, all I needed to do
was wrap the impure functions with <code>Async&lt;&gt;</code>. What could be easier?</p>
<p>No DSL, no Free Monad, no builder types, no interpreters were needed. <code>Async.RunSynchronously</code> was the interpreter.</p>
<p>So I rewrote the exercise using Asyncs instead:</p>
<h2>1.- <a href="http://blog.ploeh.dk/2017/07/17/a-pure-command-line-wizard/">Command-line wizard</a>:</h2>
<p>Taken from <a href="http://blog.ploeh.dk/2017/07/17/a-pure-command-line-wizard/">here</a>.</p>
<p>The basic functions:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">open</span> <span class="i">System</span>

<span class="k">let</span> <span class="i">writeLine</span> (<span class="i">s</span><span class="o">:</span><span class="i">string</span>) <span class="o">=</span> <span class="i">async</span> {        <span class="i">Console</span><span class="o">.</span><span class="i">WriteLine</span> <span class="i">s</span>  }
<span class="k">let</span> <span class="i">readLine</span>             <span class="o">=</span> <span class="i">async</span> { <span class="k">return</span> <span class="i">Console</span><span class="o">.</span><span class="i">ReadLine</span>  () }
</code></pre></td>
</tr>
</table>
<p>Some derived Console API functions</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span class="i">promptFor</span> <span class="i">test</span> <span class="i">prompt</span> <span class="i">reject</span> <span class="o">=</span> <span class="i">async</span> {
    <span class="k">do!</span>         <span class="i">writeLine</span> <span class="i">prompt</span>
    <span class="k">let!</span>   <span class="i">v</span> <span class="o">=</span>  <span class="i">readLine</span>
    <span class="k">match</span>  <span class="i">v</span> <span class="o">|&gt;</span> <span class="i">test</span> <span class="k">with</span>
    | <span class="i">Some</span> <span class="i">r</span> <span class="k">-&gt;</span> <span class="k">return</span>  <span class="i">r</span>
    | <span class="i">None</span>   <span class="k">-&gt;</span> <span class="k">do!</span>     <span class="i">writeLine</span>             <span class="i">reject</span>
                <span class="k">return!</span> <span class="i">promptFor</span> <span class="i">test</span> <span class="i">prompt</span> <span class="i">reject</span>
}

<span class="k">type</span> <span class="i">Net</span><span class="o">.</span><span class="i">Mail</span><span class="o">.</span><span class="i">MailAddress</span> <span class="k">with</span>
    <span class="k">static</span> <span class="k">member</span> <span class="i">TryParse</span> <span class="i">s</span> <span class="o">=</span> <span class="k">try</span> <span class="i">Net</span><span class="o">.</span><span class="i">Mail</span><span class="o">.</span><span class="i">MailAddress</span> <span class="i">s</span> <span class="o">|&gt;</span> <span class="i">Some</span> <span class="k">with</span> <span class="i">e</span> <span class="k">-&gt;</span> <span class="i">None</span>

<span class="k">let</span> <span class="i">promptForString</span> <span class="o">=</span> <span class="i">promptFor</span> (<span class="k">fun</span> (<span class="i">s</span><span class="o">:</span><span class="i">string</span>) <span class="k">-&gt;</span>  <span class="i">s</span><span class="o">.</span><span class="i">Trim</span>()   <span class="o">|&gt;</span> <span class="k">function</span> <span class="s">&quot;&quot;</span>      <span class="k">-&gt;</span> <span class="i">None</span>   | <span class="i">r</span> <span class="k">-&gt;</span> <span class="i">Some</span> <span class="i">r</span>)
<span class="k">let</span> <span class="i">promptForEMail</span>  <span class="o">=</span> <span class="i">promptFor</span> (<span class="i">Net</span><span class="o">.</span><span class="i">Mail</span><span class="o">.</span><span class="i">MailAddress</span><span class="o">.</span><span class="i">TryParse</span>                                            )
<span class="k">let</span> <span class="i">promptForNumber</span> <span class="o">=</span> <span class="i">promptFor</span> (<span class="i">Int32</span>               <span class="o">.</span><span class="i">TryParse</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="k">function</span> <span class="k">true</span>, <span class="i">r</span> <span class="k">-&gt;</span> <span class="i">Some</span> <span class="i">r</span> | _ <span class="k">-&gt;</span> <span class="i">None</span>  )
<span class="k">let</span> <span class="i">promptForDate</span>   <span class="o">=</span> <span class="i">promptFor</span> (<span class="i">DateTime</span>            <span class="o">.</span><span class="i">TryParse</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="k">function</span> <span class="k">true</span>, <span class="i">r</span> <span class="k">-&gt;</span> <span class="i">Some</span> <span class="i">r</span> | _ <span class="k">-&gt;</span> <span class="i">None</span>  )
</code></pre></td>
</tr>
</table>
<p>The reservation record:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span class="i">Reservation</span> <span class="o">=</span> {
    <span class="i">Date</span>     <span class="o">:</span> <span class="i">DateTime</span>
    <span class="i">Name</span>     <span class="o">:</span> <span class="i">string</span>
    <span class="i">Email</span>    <span class="o">:</span> <span class="i">string</span>
    <span class="i">Quantity</span> <span class="o">:</span> <span class="i">int</span> 
}
</code></pre></td>
</tr>
</table>
<p>A wizard to read it:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">readReservationRequest</span> <span class="o">=</span> <span class="i">async</span> {
    <span class="k">let!</span> <span class="i">count</span> <span class="o">=</span> <span class="i">promptForNumber</span> <span class="s">&quot;Please enter number of diners:&quot;</span>   <span class="s">&quot;Not a valid integer.&quot;</span>
    <span class="k">let!</span> <span class="i">date</span>  <span class="o">=</span> <span class="i">promptForDate</span>   <span class="s">&quot;Please enter your desired date:&quot;</span>  <span class="s">&quot;Not a valid date.&quot;</span>
    <span class="k">let!</span> <span class="i">name</span>  <span class="o">=</span> <span class="i">promptForString</span> <span class="s">&quot;Please enter your name:&quot;</span>          <span class="s">&quot;Not a valid name.&quot;</span>
    <span class="k">let!</span> <span class="i">email</span> <span class="o">=</span> <span class="i">promptForEMail</span>  <span class="s">&quot;Please enter your email address:&quot;</span> <span class="s">&quot;Not a valid email.&quot;</span>
    <span class="k">return</span> { <span class="i">Date</span> <span class="o">=</span> <span class="i">date</span>; <span class="i">Name</span> <span class="o">=</span> <span class="i">name</span>; <span class="i">Email</span> <span class="o">=</span> <span class="i">email</span><span class="o">.</span><span class="i">Address</span>; <span class="i">Quantity</span> <span class="o">=</span> <span class="i">count</span> } 
  }

<span class="k">let</span> <span class="i">getReservation</span> () <span class="o">=</span>
    <span class="i">readReservationRequest</span>
    <span class="o">|&gt;</span> <span class="i">Async</span><span class="o">.</span><span class="i">RunSynchronously</span>
    <span class="o">|&gt;</span> <span class="i">printfn</span> <span class="s">&quot;%A&quot;</span>
</code></pre></td>
</tr>
</table>
<h2>2.- <a href="http://blog.ploeh.dk/2017/07/31/combining-free-monads-in-f/">HTTP API client module</a></h2>
<p>Taken from <a href="http://blog.ploeh.dk/2017/07/31/combining-free-monads-in-f/">here</a>.</p>
<p>The Slot type:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span class="i">Slot</span> <span class="o">=</span> { <span class="i">Date</span> <span class="o">:</span> <span class="i">DateTime</span>; <span class="i">SeatsLeft</span> <span class="o">:</span> <span class="i">int</span> }
</code></pre></td>
</tr>
</table>
<p>The basic HTTP (mock) functions:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">random</span> <span class="o">=</span> <span class="k">lazy</span> (<span class="i">System</span><span class="o">.</span><span class="i">Random</span> <span class="i">DateTime</span><span class="o">.</span><span class="i">Now</span><span class="o">.</span><span class="i">Millisecond</span>)

<span class="k">let</span> <span class="i">getSlotsHttp</span>         <span class="i">date</span>             <span class="o">=</span> <span class="i">async</span> { <span class="k">return</span> [ { <span class="i">Date</span> <span class="o">=</span> <span class="i">date</span> ; <span class="i">SeatsLeft</span> <span class="o">=</span> <span class="i">random</span><span class="o">.</span><span class="i">Force</span>()<span class="o">.</span><span class="i">Next</span>(<span class="n">20</span>) } ] }
<span class="k">let</span> <span class="i">postReservationHttp</span> (<span class="i">res</span><span class="o">:</span><span class="i">Reservation</span>) <span class="o">=</span> <span class="i">async</span> { <span class="k">do!</span> <span class="i">Async</span><span class="o">.</span><span class="i">Sleep</span> <span class="n">1500</span>                                             }
</code></pre></td>
</tr>
</table>
<p>A reservation wizard that queries the HTTP server and makes the reservation.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">tryReserve</span>          <span class="o">=</span> <span class="i">async</span> {
    <span class="k">let!</span> <span class="i">count</span>          <span class="o">=</span> <span class="i">promptForNumber</span> <span class="s">&quot;Please enter number of diners:&quot;</span>   <span class="s">&quot;Not a valid integer.&quot;</span>
    <span class="k">let!</span> <span class="i">date</span>           <span class="o">=</span> <span class="i">promptForDate</span>   <span class="s">&quot;Please enter your desired date:&quot;</span>  <span class="s">&quot;Not a valid date.&quot;</span>
    <span class="k">let!</span> <span class="i">slots</span>          <span class="o">=</span> <span class="i">getSlotsHttp</span> <span class="i">date</span>
    <span class="k">let</span>  <span class="i">availableSeats</span> <span class="o">=</span> <span class="i">slots</span> <span class="o">|&gt;</span> <span class="i">List</span><span class="o">.</span><span class="i">sumBy</span> (<span class="k">fun</span> <span class="i">slot</span> <span class="k">-&gt;</span> <span class="i">slot</span><span class="o">.</span><span class="i">SeatsLeft</span>)
    <span class="k">if</span> <span class="i">availableSeats</span> <span class="o">&lt;</span> <span class="i">count</span>
    <span class="k">then</span> <span class="k">do!</span> <span class="i">sprintf</span> <span class="s">&quot;Only %i remaining seats.&quot;</span> <span class="i">availableSeats</span>                         <span class="o">|&gt;</span> <span class="i">writeLine</span>
    <span class="k">else</span> <span class="k">let!</span> <span class="i">name</span>      <span class="o">=</span> <span class="i">promptForString</span> <span class="s">&quot;Please enter your name:&quot;</span>          <span class="s">&quot;Not a valid name.&quot;</span>
         <span class="k">let!</span> <span class="i">email</span>     <span class="o">=</span> <span class="i">promptForEMail</span>  <span class="s">&quot;Please enter your email address:&quot;</span> <span class="s">&quot;Not a valid email.&quot;</span>
         <span class="k">do!</span> { <span class="i">Date</span>     <span class="o">=</span> <span class="i">date</span>; <span class="i">Name</span> <span class="o">=</span> <span class="i">name</span>; <span class="i">Email</span> <span class="o">=</span> <span class="i">email</span><span class="o">.</span><span class="i">Address</span>; <span class="i">Quantity</span> <span class="o">=</span> <span class="i">count</span> } <span class="o">|&gt;</span> <span class="i">postReservationHttp</span>
         <span class="k">do!</span> <span class="i">sprintf</span> <span class="s">&quot;%s party of %d, reserved for %A.&quot;</span> <span class="i">name</span> <span class="i">count</span> <span class="i">date</span>                <span class="o">|&gt;</span> <span class="i">writeLine</span>
    }

<span class="k">let</span> <span class="i">reserve</span>() <span class="o">=</span> <span class="i">tryReserve</span> <span class="o">|&gt;</span> <span class="i">Async</span><span class="o">.</span><span class="i">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<p>Using async we accomplish the same objective and avoid a lot of boiler plate.</p>


          
        </div>
        <div class="span1"></div>
      </div>
      <hr style="margin-top:50px;"/>
      <footer class="footer" style="text-align:center">
          <div id="disqus_thread"></div>
          <script>
              var disqus_config = function () {
                  //this.page.url = "http://No Free Monad for old men.html";  // Replace PAGE_URL with your page's canonical URL variable
                  this.page.identifier = "No Free Monad for old men"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
              };
              (function () { // DON'T EDIT BELOW THIS LINE
                  var d = document, s = d.createElement('script');
                  s.src = 'https://amieresgithub.disqus.com/embed.js';
                  s.setAttribute('data-timestamp', +new Date());
                  (d.head || d.body).appendChild(s);
              })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </footer>
    </div>
  </body>
</html>
